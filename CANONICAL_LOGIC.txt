# CANONICAL TRADING LOGIC SPEC
Authoritative – Non-Negotiable

## Purpose
This document defines the mandatory accounting, risk, and performance logic
for the trading system. All metrics must reflect REALIZED outcomes, not
chart-perfect projections.

This document is axiomatic.
It is NOT a request for redesign, optimization, or interpretation.

---

## 1. Atomic Unit: R-Multiples

### Definition
1R = initial risk on a trade.

1R = |Entry − Stop|

### Rules
- All performance metrics MUST be stored and evaluated in R-multiples
- Currency values are derived only for display
- R normalizes performance across instruments, sizes, and account types

### Examples
- Risk $100, profit $300 → +3R
- Risk $100, lose $50 → −0.5R

---

## 2. Calculation Engines (MANDATORY SEPARATION)

Two engines MUST exist and remain distinct.

---

### 2A. Theoretical RR Engine (Pre-Trade)

Purpose:
- Planning
- Scanning
- Chart evaluation

Inputs:
- Entry (Pe)
- Stop (Psl)
- Target (Ptp)

Formulas:
- Long:
  RR_theoretical = (Ptp − Pe) / (Pe − Psl)
- Short:
  RR_theoretical = (Pe − Ptp) / (Psl − Pe)

Validation:
- Flag RR < 1.0
- Flag targets exceeding ADR / ATR bounds

---

### 2B. Realized RR Engine (Post-Trade / Simulation)

Purpose:
- Truthful performance
- Expectancy
- Survivability

Required Inputs:
- Slippage (entry + exit)
- Commission (entry + exit)
- Spread
- Financing (if applicable)

#### Realized Risk ($)
Costs INCREASE risk.

Realized_Risk_$ =
(|Pe − Psl| × PointValue)
+ Slippage_entry
+ Slippage_exit
+ Commission_entry
+ Commission_exit
+ Spread

#### Realized Reward ($)
Costs REDUCE reward.

Realized_Reward_$ =
(|Ptp − Pe| × PointValue)
− Slippage_entry
− Slippage_exit
− Commission_entry
− Commission_exit
− Spread

#### Realized RR
Realized_RR = Realized_Reward_$ / Realized_Risk_$

Rule:
Any discrepancy between theoretical RR and realized RR MUST be visible.

---

## 3. Position Sizing Logic

### Standard Account
Risk is based on equity.

PositionSize =
(AccountEquity × Risk%) / (|Pe − Psl| × PointValue)

---

### Prop Firm Mode (CRITICAL)

Usable risk capital = Max Drawdown (NOT account balance)

True_Risk_% = RiskAmount / MaxDrawdown

Example:
- Account: $100k
- Max DD: $5k
- Risk: $500

True_Risk_% = 10%

Rule:
True Risk % MUST be displayed.

---

## 4. Strategy Viability Metrics (REQUIRED)

### Expectancy (in R)
E = (WinRate × AvgWin_R) − (LossRate × AvgLoss_R)

If E ≤ 0 after costs → strategy is invalid.

---

### Risk of Ruin (RoR)
Inputs:
- Win rate
- Payoff ratio
- TRUE risk %

Rule:
Warn user if RoR exceeds safety threshold.

---

### Walk-Forward Validation
- Optimize In-Sample
- Validate Out-of-Sample
- Roll forward
- Material degradation OOS = non-robust strategy

---

## 5. Execution & Order Types

Trades MUST be categorized:

- Market: highest slippage
- Limit: low slippage, fill risk
- Stop-Entry: worst slippage in volatility

Missed limit trades MUST be tracked.

---

## 6. Dynamic Reward Logic

### Volatility-Aware Targets
- Evaluate targets against ADR / ATR
- Flag targets exceeding remaining range

---

### Scaled Exits (Blended R)
Blended_R = Σ (ExitFraction_i × R_i)

Example:
50% at 1R, 50% at 3R → 2R

Each R MUST be net of costs.

---

## 7. Developer Checklist

- Store outcomes in R
- Separate theoretical vs realized RR
- Include ALL costs inside RR
- Support prop-firm drawdown logic
- Compute expectancy and RoR
- Display true risk + realized expectancy

---

## Final Rule
If a metric does not reflect real money behavior,
it must not be presented as truth.
